--글 번호 시퀀스(PRIMARY KEY)
CREATE SEQUENCE BOARDNOSQ NOCACHE;

--그룹번호 시퀀스(새로운 글 등록할때)
CREATE SEQUENCE GROUPNOSQ NOCACHE;

-- 글 번호 , 그룹번호 , 그룹순서 , 제목탭 
-- 제목 , 내용 ,작성자,작성일
CREATE TABLE ANSWERBOARD( 
	BOARDNO NUMBER PRIMARY KEY,
	GROUPNO NUMBER NOT NULL,
	GROUPSQ NUMBER NOT NULL,
	TITLETAB NUMBER NOT NULL,
	TITLE VARCHAR2(2000) NOT NULL,
	CONTENT VARCHAR2(4000) NOT NULL,
	WRITER VARCHAR2(1000) NOT NULL,
	REGDATE DATE NOT NULL
);

SELECT * FROM ANSWERBOARD ORDER BY GROUPNO DESC, GROUPSQ;

-- 첫번째 글 작성
INSERT INTO ANSWERBOARD VALUES
(BOARDNOSQ.NEXTVAL , GROUPNOSQ.NEXTVAL, 1 , 0 , '첫번째글' , '1번글입니다.' , '유저1' ,SYSDATE);

-- 두번째 글 작성
INSERT INTO ANSWERBOARD VALUES
(BOARDNOSQ.NEXTVAL , GROUPNOSQ.NEXTVAL, 1 , 0 , '두번째글' , '2번글입니다.' , '유저2' ,SYSDATE);

--1번글 답글작성
--부모와 같은 groupno
--부모의 groupsq +1 , 부모의 titletab +1
INSERT INTO ANSWERBOARD VALUES
(BOARDNOSQ.NEXTVAL , 
(SELECT GROUPNO FROM ANSWERBOARD WHERE BOARDNO = 1),
(SELECT GROUPSQ FROM ANSWERBOARD WHERE BOARDNO=1)+1,
(SELECT TITLETAB FROM ANSWERBOARD WHERE BOARDNO= 1)+1,
'RE:첫번째 글' ,'1번글의 답글입니다.' , '유저2' ,SYSDATE); 

SELECT * FROM ANSWERBOARD ORDER BY GROUPNO DESC GROUPSQ;


-- 세번째 글 작성
INSERT INTO ANSWERBOARD VALUES
(BOARDNOSQ.NEXTVAL , GROUPNOSQ.NEXTVAL, 1 , 0 , '세번째글' , '3번글입니다.' , '유저3' ,SYSDATE);


SELECT * FROM ANSWERBOARD ORDER BY GROUPNO DESC, GROUPSQ;

--두번째 글 답글 작성
INSERT INTO ANSWERBOARD VALUES
(BOARDNOSQ.NEXTVAL , 
(SELECT GROUPNO FROM ANSWERBOARD WHERE BOARDNO = 2) ,
(SELECT GROUPSQ FROM ANSWERBOARD WHERE  BOARDNO = 2)+1,
(SELECT TITLETAB FROM ANSWERBOARD WHERE BOARDNO =2)+1,
'RE:두번째글' , '2번글의 답글입니다(1)', '유저1' ,SYSDATE);


--답글작성 (RE:두번째글 no.5)
-- 부모와 같은 groupno
-- 부모의 groupsq +1 , titletab+1
INSERT INTO ANSWERBOARD VALUES
(BOARDNOSQ.NEXTVAL , 
(SELECT GROUPNO FROM ANSWERBOARD WHERE BOARDNO=5),
(SELECT GROUPSQ FROM ANSWERBOARD WHERE BOARDNO=5)+1,
(SELECT TITLETAB FROM ANSWERBOARD WHERE BOARDNO=5)+1,
'RE:RE: 두번째글' , '2번글의 답글입니다(2)' , '유저2' , SYSDATE
);


SELECT * FROM ANSWERBOARD ORDER BY GROUPNO DESC, GROUPSQ;

--이미 답글이 존재하는 2번글에 답글을 다시 달 경우
UPDATE ANSWERBOARD SET GROUPSQ = GROUPSQ+1 
WHERE GROUPNO = (SELECT GROUPNO FROM ANSWERBOARD WHERE BOARDNO = 2)
AND
	GROUPSQ >(SELECT GROUPSQ FROM ANSWERBOARD WHERE BOARDNO=2);
	
	
	
INSERT INTO ANSWERBOARD VALUES
(BOARDNOSQ.NEXTVAL , 
(SELECT GROUPNO FROM ANSWERBOARD WHERE BOARDNO=2),
(SELECT GROUPSQ FROM ANSWERBOARD WHERE BOARDNO=2)+1,
(SELECT TITLETAB FROM ANSWERBOARD WHERE BOARDNO=2)+1,
'RE: 두번째글' , '2번글의 답글입니다(2)' , '유저2' , SYSDATE
);

--boardno 가 7인 글에 답글을 다는 경우
UPDATE ANSWERBOARD SET GROUPSQ = GROUPSQ+1 
WHERE GROUPNO = (SELECT GROUPNO FROM ANSWERBOARD WHERE BOARDNO = 7)
AND
	GROUPSQ >(SELECT GROUPSQ FROM ANSWERBOARD WHERE BOARDNO=7);
	

INSERT INTO ANSWERBOARD VALUES
(BOARDNOSQ.NEXTVAL , 
(SELECT GROUPNO FROM ANSWERBOARD WHERE BOARDNO=7),
(SELECT GROUPSQ FROM ANSWERBOARD WHERE BOARDNO=7)+1,
(SELECT TITLETAB FROM ANSWERBOARD WHERE BOARDNO=7)+1,
'RE: 두번째글' , '2번글의 답글입니다(2)' , '유저2' , SYSDATE
);
	
